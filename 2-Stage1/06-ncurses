# Stage 1: ncurses
# Build and install as cmlfs

# Ensure gawk exist on the host
mkdir build
pushd build
    CC=clang CXX=clang++ \
    LD=ld.mold \
    AR=llvm-ar AS=llvm-as \
    RANLIB=llvm-ranlib STRIP=llvm-strip \
    ../configure AWK=gawk
    make -C include -j`nproc --all`
    make -C progs tic -j`nproc --all`
popd

# Build
CC=clang CXX=clang++ \
LD=ld.mold \
AR=llvm-ar AS=llvm-as \
RANLIB=llvm-ranlib STRIP=llvm-strip \
OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump \
./configure \
    --prefix=/llvmtools \
    --build=x86_64-cmlfs-linux-musl \
    --host=x86_64-cmlfs-linux-musl \
    --with-shared \
    --without-normal \
    --with-cxx-shared \
    --without-debug \
    --without-ada \
    --disable-stripping \
    AWK=gawk

# Install to llvmtools
make -j`nproc --all` && make TIC_PATH=$(pwd)/build/progs/tic install

ln -sv libncursesw.so /llvmtools/lib/libncurses.so
sed -e 's/^#if.*XOPEN.*$/#if 1/' \
    -i /llvmtools/include/ncursesw/curses.h

# Some packages may not configure with the curses library
# in llvmtools. Create a compatibility links:
ln -sv libncurses.so /llvmtools/lib/libtinfo.so
ln -sv libncurses.so /llvmtools/lib/libtinfow.so

# fix python cannot find term.h
cd /llvmtools/include/ncursesw && mv * ../

ln -s ../curses.h &&
ln -s ../cursesapp.h &&
ln -s ../cursesf.h &&
ln -s ../cursesm.h &&
ln -s ../cursesp.h &&
ln -s ../cursesw.h &&
ln -s ../cursslk.h &&
ln -s ../eti.h &&
ln -s ../etip.h &&
ln -s ../form.h &&
ln -s ../menu.h &&
ln -s ../ncurses.h &&
ln -s ../ncurses_dll.h &&
ln -s ../panel.h &&
ln -s ../term.h &&
ln -s ../term_entry.h &&
ln -s ../termcap.h &&
ln -s ../unctrl.h
