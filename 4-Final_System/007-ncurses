# Final System: ncurses
# This section is done in Chroot environment

# Build
# CC=clang CXX=clang++ \
# LD=ld.mold \
# AR=llvm-ar AS=llvm-as \
# RANLIB=llvm-ranlib STRIP=llvm-strip \
# OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump \
./configure \
    --prefix=/usr \
    --mandir=/usr/share/man \
    --with-shared \
    --without-debug \
    --without-normal \
    --with-cxx-shared \
    --enable-cmlfs-files \
    --with-pkg-config-libdir=/usr/lib/pkgconfig

make -j`nproc --all`

# Install
make DESTDIR=$PWD/dest install
install -vm755 dest/usr/lib/libncursesw.so.6.5 /usr/lib
rm -v  dest/usr/lib/libncursesw.so.6.5
sed -e 's/^#if.*XOPEN.*$/#if 1/' \
    -i dest/usr/include/curses.h
cp -av dest/* /

# Some packages may not configure with the curses library.
# Create a compatibility link:
ln -sfv libncursesw.so /usr/lib/libncurses.so
ln -sfv libncurses.so  /usr/lib/libtinfo.so

# Set the dynamic loader for each executable
for b in infocmp tabs tic tput tset
do
    patchelf --set-interpreter /lib/ld-musl-x86_64.so.1 /usr/bin/$b
done

# fix python cannot find term.h
cd /usr/include/ncursesw && mv * ../

ln -s ../curses.h &&
ln -s ../cursesapp.h &&
ln -s ../cursesf.h &&
ln -s ../cursesm.h &&
ln -s ../cursesp.h &&
ln -s ../cursesw.h &&
ln -s ../cursslk.h &&
ln -s ../eti.h &&
ln -s ../etip.h &&
ln -s ../form.h &&
ln -s ../menu.h &&
ln -s ../ncurses.h &&
ln -s ../ncurses_dll.h &&
ln -s ../panel.h &&
ln -s ../term.h &&
ln -s ../term_entry.h &&
ln -s ../termcap.h &&
ln -s ../unctrl.h
